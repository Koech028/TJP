<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reset Password | TradeJournal Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-gradient: linear-gradient(135deg, #2563eb, #8b5cf6);
            --dark-bg: #0f172a;
            --dark-container: rgba(15, 23, 42, 0.85);
            --darker: #1e293b;
            --text: white;
            --accent: #3b82f6;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --gray: #94a3b8;
            --light-blue: #93c5fd;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark-bg), var(--darker));
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            background: var(--dark-container);
            padding: 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .description {
            text-align: center;
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 1rem;
        }

        .user-email {
            text-align: center;
            font-size: 0.95rem;
            color: var(--light-blue);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .input-icon {
            position: relative;
        }

        .input-icon input {
            width: 100%;
            padding: 15px 45px 15px 40px;
            border-radius: 10px;
            border: 1px solid #334155;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input-icon input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .input-icon i {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .toggle-password {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }

        .toggle-password:hover {
            color: var(--accent);
        }

        .password-strength {
            margin-top: 8px;
            height: 6px;
            background: var(--darker);
            border-radius: 10px;
            overflow: hidden;
        }

        .strength-meter {
            height: 100%;
            width: 0%;
            background: var(--error);
            transition: width 0.3s ease, background 0.3s ease;
        }

        .password-rules {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 10px;
            list-style: none;
        }

        .password-rules li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .password-rules li i {
            font-size: 0.8rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
        }

        .password-rules li.valid {
            color: var(--success);
        }

        .password-rules li.valid i {
            background: var(--success);
            color: white;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            background: var(--primary-gradient);
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.6);
        }

        .btn:disabled {
            background: #4b5563;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message i {
            font-size: 1.2rem;
        }

        .message.success {
            background: rgba(22, 163, 74, 0.2);
            border: 1px solid rgba(22, 163, 74, 0.4);
            color: #86efac;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fca5a5;
        }

        .message.info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            color: #93c5fd;
        }

        .footer {
            text-align: center;
            margin-top: 25px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .footer a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .otp-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 5px;
        }

        .otp-input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 1.5rem;
            border-radius: 10px;
            border: 1px solid #334155;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            transition: all 0.2s;
        }

        .otp-input:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        .resend-container {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .resend-link {
            color: var(--accent);
            cursor: pointer;
            text-decoration: none;
            margin-left: 5px;
        }

        .resend-link:hover {
            text-decoration: underline;
        }

        .resend-link.disabled {
            color: var(--gray);
            cursor: not-allowed;
            text-decoration: none;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            gap: 10px;
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            position: relative;
        }

        .step.active {
            background: var(--primary);
        }

        .step.completed {
            background: var(--success);
        }

        .step.completed::after {
            content: "\f00c";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
        }

        .step:not(:last-child)::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 100%;
            width: 20px;
            height: 2px;
            background: #334155;
            transform: translateY(-50%);
        }

        .step.completed:not(:last-child)::before {
            background: var(--success);
        }

        .step-label {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--gray);
            font-weight: normal;
        }

        .step.active .step-label {
            color: var(--accent);
            font-weight: 500;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent);
            margin-bottom: 20px;
            cursor: pointer;
            font-weight: 500;
            width: fit-content;
        }

        .back-button:hover {
            text-decoration: underline;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Reset Your Password</h2>

        <div class="step-indicator">
            <div class="step active" id="step1">
                <span>1</span>
                <span class="step-label">Email</span>
            </div>
            <div class="step" id="step2">
                <span>2</span>
                <span class="step-label">OTP</span>
            </div>
            <div class="step" id="step3">
                <span>3</span>
                <span class="step-label">Password</span>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div id="messageContainer"></div>

        <!-- Step 1: Email Entry -->
        <div class="form-section active" id="emailSection">
            <div class="description">
                Enter your email address to receive a verification code
            </div>

            <div class="form-group">
                <label for="email">Email Address</label>
                <div class="input-icon">
                    <i class="fas fa-envelope"></i>
                    <input type="email" name="email" id="email" placeholder="your.email@example.com" required>
                </div>
            </div>

            <button type="button" class="btn" id="sendOtpBtn">
                <i class="fas fa-paper-plane"></i> Send Verification Code
            </button>

            <div class="footer">
                Remembered your password? <a href="#">Sign In</a>
            </div>
        </div>

        <!-- Step 2: OTP Verification -->
        <div class="form-section" id="otpSection">
            <div class="back-button" id="backToEmail">
                <i class="fas fa-arrow-left"></i> Back
            </div>

            <div class="description">
                We've sent a 6-digit code to <span id="emailDisplay" class="user-email"></span>
            </div>

            <div class="form-group">
                <label for="otp">Verification Code</label>
                <div class="otp-container">
                    <input type="text" maxlength="1" class="otp-input" id="otp1">
                    <input type="text" maxlength="1" class="otp-input" id="otp2">
                    <input type="text" maxlength="1" class="otp-input" id="otp3">
                    <input type="text" maxlength="1" class="otp-input" id="otp4">
                    <input type="text" maxlength="1" class="otp-input" id="otp5">
                    <input type="text" maxlength="1" class="otp-input" id="otp6">
                </div>
            </div>

            <div class="resend-container">
                Didn't receive the code?
                <a href="#" class="resend-link" id="resendLink">Resend Code</a>
                <span id="resendTimer">(00:60)</span>
            </div>

            <button type="button" class="btn" id="verifyOtpBtn" disabled>
                <i class="fas fa-check-circle"></i> Verify Code
            </button>
        </div>

        <!-- Step 3: Password Reset -->
        <div class="form-section" id="passwordSection">
            <div class="back-button" id="backToOtp">
                <i class="fas fa-arrow-left"></i> Back
            </div>

            <div class="user-email">
                <i class="fas fa-envelope"></i> <span id="passwordEmailDisplay"></span>
            </div>

            <form id="resetForm">
                <div class="form-group">
                    <label for="password">New Password</label>
                    <div class="input-icon password-container">
                        <i class="fas fa-lock"></i>
                        <input type="password" name="password" id="password" required>
                        <span class="toggle-password" id="togglePassword"><i class="fas fa-eye"></i></span>
                    </div>
                    <div class="password-strength">
                        <div class="strength-meter" id="strengthMeter"></div>
                    </div>
                    <ul class="password-rules">
                        <li id="lengthRule"><i class="fas fa-circle"></i> At least 8 characters</li>
                        <li id="letterRule"><i class="fas fa-circle"></i> At least one letter</li>
                        <li id="numberRule"><i class="fas fa-circle"></i> At least one number</li>
                        <li id="specialRule"><i class="fas fa-circle"></i> At least one special character</li>
                    </ul>
                </div>

                <div class="form-group">
                    <label for="confirm">Confirm Password</label>
                    <div class="input-icon password-container">
                        <i class="fas fa-lock"></i>
                        <input type="password" name="confirm" id="confirm" required>
                        <span class="toggle-password" id="toggleConfirm"><i class="fas fa-eye"></i></span>
                    </div>
                    <div id="confirmMessage" style="font-size: 0.85rem; margin-top: 5px;"></div>
                </div>

                <button type="button" class="btn" id="resetBtn" disabled>
                    <i class="fas fa-sync-alt"></i> Reset Password
                </button>
            </form>

            <div class="footer">
                Remembered your password? <a href="#">Sign In</a>
            </div>
        </div>
    </div>
    <script>

    // Fully integrated reset-password script 
document.addEventListener('DOMContentLoaded', function () {
  "use strict";

  /* ---------------- DOM ---------------- */
  const emailSection            = document.getElementById('emailSection');
  const otpSection              = document.getElementById('otpSection');
  const passwordSection         = document.getElementById('passwordSection');

  const sendOtpBtn              = document.getElementById('sendOtpBtn');
  const verifyOtpBtn            = document.getElementById('verifyOtpBtn');
  const resetBtn                = document.getElementById('resetBtn');

  const backToEmail             = document.getElementById('backToEmail');
  const backToOtp               = document.getElementById('backToOtp');

  const emailInput              = document.getElementById('email');
  const emailDisplay            = document.getElementById('emailDisplay');
  const passwordEmailDisplay    = document.getElementById('passwordEmailDisplay');

  const resendLink              = document.getElementById('resendLink');
  const resendTimer             = document.getElementById('resendTimer');

  const messageContainer        = document.getElementById('messageContainer');

  // Password
  const passwordInput           = document.getElementById('password');
  const confirmInput            = document.getElementById('confirm');
  const togglePassword          = document.getElementById('togglePassword');
  const toggleConfirm           = document.getElementById('toggleConfirm');
  const strengthMeter           = document.getElementById('strengthMeter');

  // OTP inputs
  const otpInputs = [
    document.getElementById('otp1'),
    document.getElementById('otp2'),
    document.getElementById('otp3'),
    document.getElementById('otp4'),
    document.getElementById('otp5'),
    document.getElementById('otp6')
  ];

  /* ---------------- State ---------------- */
  let currentStep   = 1;
  let userEmail     = '';
  let resendTime    = 60;
  let resendInterval = null;

  /* ---------------- API endpoints ---------------- */
  const API = {
    username:       '/api/get-username',
    requestReset:   '/api/request-reset',
    verifyOtp:      '/api/verify-otp',
    resetPassword:  '/api/reset-password',
  };

  /* ---------------- Utilities ---------------- */

  function validateEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function isPasswordStrong(p) {
    return (
      p.length >= 8 &&
      /[A-Za-z]/.test(p) &&
      /[0-9]/.test(p) &&
      /[!@#$%^&*(),.?":{}|<>]/.test(p)
    );
  }

  function toggleVisibility(input, toggleEl) {
    const toType = input.type === 'password' ? 'text' : 'password';
    input.type = toType;
    toggleEl.innerHTML = `<i class="fas ${toType === 'password' ? 'fa-eye' : 'fa-eye-slash'}"></i>`;
  }

  function showMessage(text, type) {
    const icons = {
      success: 'fas fa-check-circle',
      error:   'fas fa-exclamation-circle',
      info:    'fas fa-info-circle'
    };
    const box = document.createElement('div');
    box.className = `message ${type}`;
    box.innerHTML = `<i class="${icons[type] || icons.info}"></i> ${text}`;
    messageContainer.innerHTML = '';
    messageContainer.appendChild(box);

    // Auto-dismiss non-error after 5s
    if (type !== 'error') {
      setTimeout(() => {
        if (box.parentNode) box.remove();
      }, 5000);
    }
  }

  // Safe fetch JSON wrapper
  async function fetchJSON(url, opts = {}) {
    let res;
    try {
      res = await fetch(url, opts);
    } catch (netErr) {
      return { ok: false, status: 0, data: { error: 'Network error' } };
    }
    let data;
    try {
      data = await res.json();
    } catch {
      data = { error: 'Invalid server response' };
    }
    return { ok: res.ok, status: res.status, data };
  }

  function navigateToStep(step) {
    currentStep = step;
    emailSection.classList.toggle('active', step === 1);
    otpSection.classList.toggle('active', step === 2);
    passwordSection.classList.toggle('active', step === 3);

    // Step indicator circles
    document.querySelectorAll('.step').forEach((el, i) => {
      const n = i + 1;
      el.classList.toggle('completed', n < step);
      el.classList.toggle('active', n === step);
    });
  }

  function startResendTimer() {
    resendTime = 60;
    resendLink.classList.add('disabled');
    resendTimer.textContent = `(00:${resendTime})`;

    if (resendInterval) clearInterval(resendInterval);
    resendInterval = setInterval(() => {
      resendTime--;
      resendTimer.textContent = `(00:${resendTime < 10 ? '0' : ''}${resendTime})`;
      if (resendTime <= 0) {
        clearInterval(resendInterval);
        resendTimer.textContent = '';
        resendLink.classList.remove('disabled');
      }
    }, 1000);
  }

  /* ---------------- Password Strength + Confirm ---------------- */

  function validatePassword() {
    const p = passwordInput.value;
    const validLength = p.length >= 8;
    const hasLetter = /[A-Za-z]/.test(p);
    const hasNumber = /[0-9]/.test(p);
    const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(p);

    let score = 0;
    if (validLength) score += 25;
    if (hasLetter)  score += 25;
    if (hasNumber)  score += 25;
    if (hasSpecial) score += 25;

    strengthMeter.style.width = score + '%';
    strengthMeter.style.background =
      score < 50 ? '#e74c3c' :
      score < 75 ? '#f39c12' : '#10b981';

    document.getElementById('lengthRule').className  = validLength ? 'valid' : '';
    document.getElementById('letterRule').className  = hasLetter  ? 'valid' : '';
    document.getElementById('numberRule').className  = hasNumber  ? 'valid' : '';
    document.getElementById('specialRule').className = hasSpecial ? 'valid' : '';

    checkPasswordMatch();
  }

    function checkPasswordMatch() {
        const pass = passwordInput.value;
        const conf = confirmInput.value;
        const msgEl = document.getElementById('confirmMessage');

        if (!conf) {
            msgEl.textContent = '';
            resetBtn.disabled = true;
            return;
        }

        if (pass === conf) {
            msgEl.textContent = 'Passwords match!';
            msgEl.style.color = '#10b981';
        } else {
            msgEl.textContent = 'Passwords do not match!';
            msgEl.style.color = '#ef4444';
            resetBtn.disabled = true;
            return;
        }

        // ✅ Enable button only if password is strong and matches
        const isStrong = (
            pass.length >= 8 &&
            /[A-Za-z]/.test(pass) &&
            /[0-9]/.test(pass) &&
            /[!@#$%^&*(),.?":{}|<>]/.test(pass)
        );

        resetBtn.disabled = !isStrong;
    }


  /* ---------------- OTP Inputs ---------------- */

  function setupOtpInputs() {
    otpInputs.forEach((input, i) => {
      input.addEventListener('input', () => {
        // Only allow 1 digit numeric
        input.value = input.value.replace(/\D/g, '').slice(0,1);

        if (input.value && i < otpInputs.length - 1) {
          otpInputs[i + 1].focus();
        }
        verifyOtpBtn.disabled = otpInputs.some(inp => inp.value.length !== 1);
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !input.value && i > 0) {
          otpInputs[i - 1].focus();
        }
      });
    });
  }

  /* ---------------- Actions ---------------- */

  async function sendOtp() {
    const email = emailInput.value.trim().toLowerCase();
    if (!validateEmail(email)) {
      showMessage('Please enter a valid email address.', 'error');
      return;
    }

    sendOtpBtn.disabled = true;
    sendOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    // 1. Fetch username (optional UX)
    const unameRes = await fetchJSON(API.username, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',          // in case cookies needed for CSRF/JWT
      body: JSON.stringify({ email })
    });

    if (!unameRes.ok) {
      showMessage(unameRes.data.error || 'Email not found.', 'error');
      sendOtpBtn.disabled = false;
      sendOtpBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Verification Code';
      return;
    }
    const username = unameRes.data.username || email;

    // 2. Request OTP
    const otpRes = await fetchJSON(API.requestReset, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ email })
    });

    if (otpRes.ok) {
      userEmail = email;
      emailDisplay.textContent = email;
      passwordEmailDisplay.textContent = email;
      showMessage(`Hello, ${username}! ${otpRes.data.message || 'Verification code sent.'}`, 'success');
      navigateToStep(2);
      startResendTimer();
    } else {
      showMessage(otpRes.data.error || 'Failed to send verification code.', 'error');
    }

    sendOtpBtn.disabled = false;
    sendOtpBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Verification Code';
  }

  async function resendOtp(e) {
    e.preventDefault();
    if (resendLink.classList.contains('disabled') || !userEmail) return;

    const res = await fetchJSON(API.requestReset, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ email: userEmail })
    });

    if (res.ok) {
      showMessage(res.data.message || 'Code resent.', 'success');
      startResendTimer();
    } else {
      showMessage(res.data.error || 'Failed to resend code.', 'error');
    }
  }

  async function verifyOtp() {
    const enteredOtp = otpInputs.map(i => i.value).join('');
    if (enteredOtp.length !== 6) {
      showMessage('Enter all 6 digits.', 'error');
      return;
    }

    verifyOtpBtn.disabled = true;
    verifyOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

    const res = await fetchJSON(API.verifyOtp, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ email: userEmail, otp: enteredOtp })
    });

    if (res.ok) {
      showMessage(res.data.message || 'Code verified!', 'success');
      navigateToStep(3);
    } else {
      showMessage(res.data.error || 'Invalid or expired code.', 'error');
    }

    verifyOtpBtn.disabled = false;
    verifyOtpBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verify Code';
  }

  async function resetPassword(e) {
    e.preventDefault();
    const password = passwordInput.value;
    const confirm  = confirmInput.value;

    if (password !== confirm) {
      showMessage('Passwords do not match.', 'error');
      return;
    }
    if (!isPasswordStrong(password)) {
      showMessage('Password too weak.', 'error');
      return;
    }

    resetBtn.disabled = true;
    resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';

    const res = await fetchJSON(API.resetPassword, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ email: userEmail, password })
    });

    if (res.ok) {
      showMessage(res.data.message || 'Password reset successful!', 'success');
      const redirectTo = res.data.redirect || '/sign.html';
      setTimeout(() => { window.location.href = redirectTo; }, 3000);
    } else {
      showMessage(res.data.error || 'Password reset failed.', 'error');
    }

    resetBtn.disabled = false;
    resetBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Reset Password';
  }

  /* ---------------- Event Wiring ---------------- */
  function init() {
    sendOtpBtn.addEventListener('click', sendOtp);
    verifyOtpBtn.addEventListener('click', verifyOtp);
    resetBtn.addEventListener('click', resetPassword);

    backToEmail.addEventListener('click', () => navigateToStep(1));
    backToOtp.addEventListener('click', () => navigateToStep(2));

    resendLink.addEventListener('click', resendOtp);

    togglePassword.addEventListener('click', () => toggleVisibility(passwordInput, togglePassword));
    toggleConfirm.addEventListener('click',  () => toggleVisibility(confirmInput,  toggleConfirm));

    passwordInput.addEventListener('input', validatePassword);
    confirmInput.addEventListener('input', checkPasswordMatch);

    setupOtpInputs();
  }

  init();
});
</script>
</body>
</html>